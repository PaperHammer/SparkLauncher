<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SparkLauncher.WinUI.Views.TaskPipeLine"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SparkLauncher.WinUI.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:taskData="using:SparkLauncher.Tasks"
    xmlns:data="using:SparkLauncher.WinUI.UIComponent.Data"
    xmlns:cvs="using:SparkLauncher.WinUI.UIComponent.Converters"
    Loaded="Page_Loaded"
    mc:Ignorable="d"
    Margin="10 0">

    <Page.Resources>
        <cvs:KeyToI18nConverter x:Key="KeyToI18n"/>
        <cvs:MessageTypeToColorConverter x:Key="MsgToColor"/>
        <cvs:MessageTypeToStringConverter x:Key="MsgToString"/>

        <Style x:Key="TaskPipeLineListContainersStyle" TargetType="ListViewItem">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Grid Background="{TemplateBinding Background}">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="PointerOver">
                                        <Storyboard>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="BackgroundBorder"
                                                Storyboard.TargetProperty="Opacity"
                                                To="0.3" Duration="0:0:0.1"/>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                                <VisualStateGroup x:Name="SelectionStates">
                                    <VisualState x:Name="Selected">
                                        <Storyboard>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="ContentPresenter"
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                To="0.9" Duration="0:0:0.2"/>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="ContentPresenter"
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                To="0.9" Duration="0:0:0.2"/>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="BackgroundBorder"
                                                Storyboard.TargetProperty="Opacity"
                                                To="0.3" Duration="0:0:0.2"/>
                                            <!--<ObjectAnimationUsingKeyFrames 
                                                Storyboard.TargetName="BackgroundBorder"
                                                Storyboard.TargetProperty="Opacity">
                                                <DiscreteObjectKeyFrame KeyTime="0" Value="0.3" />
                                            </ObjectAnimationUsingKeyFrames>-->
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="UnSelected">
                                        <Storyboard>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="ContentPresenter"
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                To="1" Duration="0:0:0.2"/>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="ContentPresenter"
                                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                To="1" Duration="0:0:0.2"/>
                                            <DoubleAnimation 
                                                Storyboard.TargetName="BackgroundBorder"
                                                Storyboard.TargetProperty="Opacity"
                                                To="0" Duration="0:0:0.2"/>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>

                            <ContentPresenter 
                                x:Name="ContentPresenter"                                
                                CornerRadius="4"
                                ContentTemplate="{TemplateBinding ContentTemplate}"
                                Content="{TemplateBinding Content}"
                                RenderTransformOrigin="0.5 0.5">
                                <ContentPresenter.RenderTransform>
                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                </ContentPresenter.RenderTransform>
                            </ContentPresenter>

                            <Border 
                                x:Name="BackgroundBorder"
                                BorderBrush="{ThemeResource SystemFillColorAttentionBrush}"
                                Opacity="0"
                                CornerRadius="4"
                                RenderTransformOrigin="0.5 0.5">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="LightGray" Offset="0.0"/>
                                        <GradientStop Color="Gray" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </Border.Background>
                                <Border.RenderTransform>
                                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                                </Border.RenderTransform>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <DataTemplate x:Key="TaskItemTemplate" x:DataType="taskData:TaskHandler">
            <ListViewItem>
                <data:PendingTaskItem                     
                    TaskName="{Binding TaskName, Converter={StaticResource KeyToI18n}}"                    
                    Status="{Binding Status}"/>
            </ListViewItem>
        </DataTemplate>
    </Page.Resources>

    <Grid
        x:Name="MainGrid"
        Margin="25 15">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="0.3*"/>
            <ColumnDefinition Width="0.7*"/>
        </Grid.ColumnDefinitions>

        <ListView
            x:Name="TaskListView" 
            Padding="0 0 16 0"
            SelectionMode="Single"
            SelectedIndex="{Binding SelectedTaskIdx, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            ItemsSource="{Binding PendingTaskItems}"
            ItemTemplate="{StaticResource TaskItemTemplate}"
            ItemContainerStyle="{StaticResource TaskPipeLineListContainersStyle}"
            SelectionChanged="TaskListView_SelectionChanged"
            FocusVisualPrimaryThickness="0"
            FocusVisualSecondaryThickness="0"/>

        <ItemsView 
            Grid.Column="2"
            ItemsSource="{Binding Blocks}"
            ScrollViewer.VerticalScrollBarVisibility="Visible"
            SelectionMode="None">
            <ItemsView.ItemTemplate>
                <DataTemplate x:DataType="taskData:TaskMsg">
                    <ItemContainer>
                        <RichTextBlock 
                            TextAlignment="Start" 
                            Padding="4" 
                            TextWrapping="WrapWholeWords">
                            <Paragraph                                   
                                ScrollViewer.VerticalScrollBarVisibility="Auto">
                                <Run Text="{Binding MsgType, Converter={StaticResource MsgToString}}" 
                                     FontWeight="Bold" 
                                     Foreground="{Binding MsgType, Converter={StaticResource MsgToColor}}"/>

                                <Run Text="{Binding DateTime}" Foreground="Gray"/>

                                <Run Text="{Binding Content}"/>
                            </Paragraph>
                        </RichTextBlock>
                    </ItemContainer>
                    
                </DataTemplate>
            </ItemsView.ItemTemplate>
        </ItemsView>
    </Grid>
</Page>
